openapi: 3.0.3
info:
  title: Transaction Validation API
  description: |
    Transaction validation API for external systems (ERP, Order Management, WMS) to validate compliance
    of controlled drug transactions. This API provides real-time compliance checks for orders and warehouse
    operations, ensuring all transactions comply with Dutch Opium Act, Medicines Act, and GDP requirements.

    **Functional Requirements Covered**: FR-018 through FR-024

    **Integration Pattern**: External order management and warehouse systems call these endpoints synchronously
    during order entry and shipment workflows. The API returns pass/fail/pending status that calling systems
    use to block or allow warehouse processing.
  version: 1.0.0
  contact:
    name: Compliance API Support
    email: compliance-api@example.nl

servers:
  - url: https://api.compliance.example.nl/api/v1
    description: Production environment
  - url: https://api-staging.compliance.example.nl/api/v1
    description: Staging environment
  - url: https://api-sandbox.compliance.example.nl/api/v1
    description: Sandbox environment for integration testing

security:
  - OAuth2:
      - compliance.transactions.validate
      - compliance.transactions.read
      - compliance.customers.read

paths:
  /transactions/validate:
    post:
      summary: Validate order compliance
      description: |
        Validates whether a proposed transaction (sales order, transfer, cross-border shipment) complies with
        all applicable licence, permit, and GDP requirements. Returns pass/fail/pending status with detailed
        violation information if non-compliant.

        **FR-018**: Accepts transaction details and returns compliance check results
        **FR-019**: Returns "pending compliance" status for orders lacking required licences
        **FR-020**: Returns structured error messages for each violation
        **FR-021**: Validates import/export permits for cross-border transactions
        **FR-022**: Checks quantity/frequency thresholds for suspicious-order monitoring
        **FR-024**: Validates both customer and company licences

        **Performance**: Responds within 3 seconds for 99% of requests (SC-032, FR-058)
      operationId: validateTransaction
      tags:
        - Transaction Validation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransactionValidationRequest'
            examples:
              domesticOrder:
                summary: Domestic order with controlled substances
                value:
                  externalId: "SO-2026-0012345"
                  transactionType: "Order"
                  direction: "Internal"
                  customerAccount: "CUST-001"
                  customerDataAreaId: "nlpd"
                  originCountry: "NL"
                  transactionDate: "2026-01-09T14:30:00Z"
                  externalUserId: "erp.user@hospital.nl"
                  lines:
                    - itemNumber: "MOR-10MG-AMP"
                      dataAreaId: "nlpd"
                      quantity: 100
                      unitOfMeasure: "ampules"
                    - itemNumber: "FEN-100MCG-PATCH"
                      dataAreaId: "nlpd"
                      quantity: 50
                      unitOfMeasure: "patches"
              crossBorderExport:
                summary: Cross-border export to Germany
                value:
                  externalId: "SO-2026-0012346"
                  transactionType: "Shipment"
                  direction: "Outbound"
                  customerAccount: "CUST-002"
                  customerDataAreaId: "nlpd"
                  originCountry: "NL"
                  destinationCountry: "DE"
                  transactionDate: "2026-01-09T15:45:00Z"
                  externalUserId: "erp.user@wholesaler.de"
                  lines:
                    - itemNumber: "MPH-18MG-TAB"
                      dataAreaId: "nlpd"
                      quantity: 500
                      unitOfMeasure: "tablets"
      responses:
        '200':
          description: Validation completed successfully (may be pass, pending, or failed)
          headers:
            X-RateLimit-Limit:
              description: Maximum requests per hour
              schema:
                type: integer
                example: 1000
            X-RateLimit-Remaining:
              description: Remaining requests in current window
              schema:
                type: integer
                example: 995
            X-RateLimit-Reset:
              description: Unix timestamp when rate limit resets
              schema:
                type: integer
                example: 1704816000
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionValidationResponse'
              examples:
                passCompliant:
                  summary: Compliant transaction (PASS)
                  value:
                    isValid: true
                    canProceed: true
                    canOverride: false
                    status: "Passed"
                    transactionId: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
                    externalId: "SO-2026-0012345"
                    validationTimeMs: 245
                    violations: []
                    licenceUsages:
                      - licenceId: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                        licenceNumber: "OA-2024-789456"
                        licenceTypeName: "Opium Act Exemption"
                        coveredLineNumbers: [1, 2]
                        coveredSubstanceCodes: ["MORPHINE"]
                        coveredQuantity: 100
                        coveredQuantityUnit: "g"
                pendingExpiredLicence:
                  summary: Non-compliant - Expired licence (FAILED)
                  value:
                    isValid: false
                    canProceed: false
                    canOverride: true
                    status: "Failed"
                    transactionId: "4fb96g75-6828-5673-c4gd-3d074g77bgb7"
                    externalId: "SO-2026-0012346"
                    validationTimeMs: 312
                    violations:
                      - errorCode: "ExpiredLicence"
                        message: "Customer's Opium Act exemption expired on 2025-12-31. Required for morphine (List I)."
                        severity: "Critical"
                        canOverride: true
                        lineNumber: 1
                        substanceCode: "MORPHINE"
                    licenceUsages: []
                failedThreshold:
                  summary: Non-compliant - Threshold exceeded (FAILED)
                  value:
                    isValid: false
                    canProceed: false
                    canOverride: true
                    status: "Failed"
                    transactionId: "5gc07h86-7939-6784-d5he-4e185h88chc8"
                    externalId: "SO-2026-0012347"
                    validationTimeMs: 278
                    violations:
                      - errorCode: "ThresholdExceeded"
                        message: "Order quantity (500 patches) exceeds monthly threshold (200 patches) for this customer and substance."
                        severity: "Critical"
                        canOverride: true
                        lineNumber: 1
                        substanceCode: "FENTANYL"
                    licenceUsages:
                      - licenceId: "b2c3d4e5-f6a7-8901-bcde-f23456789012"
                        licenceNumber: "OA-2025-111222"
                        licenceTypeName: "Opium Act Exemption"
                        coveredLineNumbers: [1]
                        coveredSubstanceCodes: ["FENTANYL"]
                        coveredQuantity: 50
                        coveredQuantityUnit: "patches"
                failedMissingPermit:
                  summary: Non-compliant - Missing import/export permit (FAILED)
                  value:
                    isValid: false
                    canProceed: false
                    canOverride: false
                    status: "Failed"
                    transactionId: "6hd18i97-8040-7895-e6if-5f296i99did9"
                    externalId: "SO-2026-0012348"
                    validationTimeMs: 195
                    violations:
                      - errorCode: "CrossBorderNoPermit"
                        message: "Export to Germany requires valid export permit from NL authorities for methylphenidate (List I precursor). No export permit found."
                        severity: "Critical"
                        canOverride: false
                        lineNumber: 1
                        substanceCode: "METHYLPHENIDATE"
                      - errorCode: "CrossBorderNoPermit"
                        message: "Import certificate from German authorities required. Customer has not provided import certificate."
                        severity: "Critical"
                        canOverride: false
                        lineNumber: 1
                        substanceCode: "METHYLPHENIDATE"
                    licenceUsages: []
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /transactions/by-external/{externalId}:
    get:
      summary: Get transaction by external ID
      description: |
        Retrieves a transaction by its external ID (ERP order number).
        Useful for polling to check if a pending transaction has been approved or rejected by compliance team.

        **FR-019b**: External systems can check override approval status

        **Performance**: Responds within 1 second for 99% of requests (SC-033)
      operationId: getTransactionByExternalId
      tags:
        - Transaction Validation
      parameters:
        - name: externalId
          in: path
          required: true
          description: External transaction ID from calling system (e.g., sales order number)
          schema:
            type: string
            example: "SO-2026-0012345"
      responses:
        '200':
          description: Transaction retrieved successfully
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
            X-RateLimit-Reset:
              $ref: '#/components/headers/X-RateLimit-Reset'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /transactions/{id}/approve:
    post:
      summary: Approve override (compliance UI)
      description: |
        Approves an override for a failed transaction. Only accessible by authorized
        compliance users (ComplianceManager role) via the compliance management UI.

        **FR-019a**: ComplianceManager override approval workflow for pending orders

        **Note**: This endpoint is intended for use by the compliance management UI, not external systems.
        External systems should poll `/transactions/by-external/{externalId}` to check approval status.
      operationId: approveOverride
      tags:
        - Transaction Validation
      security:
        - OAuth2:
            - compliance.transactions.override
      parameters:
        - name: id
          in: path
          required: true
          description: Internal transaction ID (GUID)
          schema:
            type: string
            format: uuid
            example: "4fb96g75-6828-5673-c4gd-3d074g77bgb7"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OverrideApprovalRequest'
            example:
              justification: "Emergency medical supply for hospital COVID unit. Customer's Opium Act exemption renewal application submitted to IGJ on 2025-12-15, currently in progress. Confirmed via IGJ email dated 2025-12-20. Renewal expected within 14 days."
      responses:
        '200':
          description: Override approved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /transactions/{id}/reject:
    post:
      summary: Reject override (compliance UI)
      description: |
        Rejects an override request for a failed transaction. Only accessible by authorized
        compliance users (ComplianceManager role) via the compliance management UI.

        **FR-019a**: ComplianceManager override rejection workflow
      operationId: rejectOverride
      tags:
        - Transaction Validation
      security:
        - OAuth2:
            - compliance.transactions.override
      parameters:
        - name: id
          in: path
          required: true
          description: Internal transaction ID (GUID)
          schema:
            type: string
            format: uuid
            example: "4fb96g75-6828-5673-c4gd-3d074g77bgb7"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OverrideRejectionRequest'
            example:
              reason: "Customer licence renewal has not been submitted. Cannot approve without valid documentation."
      responses:
        '200':
          description: Override rejected successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /customers/{customerAccount}/compliance-status:
    get:
      summary: Customer compliance lookup
      description: |
        Retrieves comprehensive compliance status for a customer, including active licences, approval status,
        suspension status, and expiring licences. Used by external order management systems during customer
        selection to display compliance warnings before order entry.

        Customer is identified by composite key: CustomerAccount (path) + DataAreaId (query).
        Master data sourced from D365 F&O CustomersV3; compliance extensions from Dataverse.

        **FR-060**: Customer master data synchronization API

        **Performance**: Responds within 1 second for 99% of requests (SC-033)
      operationId: getCustomerComplianceStatus
      tags:
        - Customer Compliance
      parameters:
        - name: customerAccount
          in: path
          required: true
          description: Customer account code from D365 F&O (e.g., "CUST-001")
          schema:
            type: string
            example: "CUST-001"
        - name: dataAreaId
          in: query
          required: false
          description: D365 F&O data area / legal entity ID (defaults to configured primary)
          schema:
            type: string
            example: "nlpd"
      responses:
        '200':
          description: Customer compliance status retrieved successfully
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
            X-RateLimit-Reset:
              $ref: '#/components/headers/X-RateLimit-Reset'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CustomerComplianceStatusResponse'
              examples:
                compliantCustomer:
                  summary: Fully compliant customer
                  value:
                    customerAccount: "CUST-001"
                    dataAreaId: "nlpd"
                    businessName: "Ziekenhuis St. Elisabeth"
                    businessCategory: "HospitalPharmacy"
                    country: "NL"
                    approvalStatus: "Approved"
                    isSuspended: false
                    canTransact: true
                    licences:
                      - licenceId: "lic-customer-pharmacy-001"
                        licenceNumber: "APO-2024-987654"
                        licenceType: "Hospital Pharmacy Licence"
                        status: "Valid"
                        expiryDate: "2027-06-30"
                        daysUntilExpiry: 537
                      - licenceId: "lic-customer-opium-001"
                        licenceNumber: "OA-2024-789456"
                        licenceType: "Opium Act Exemption"
                        status: "Valid"
                        expiryDate: "2026-12-31"
                        daysUntilExpiry: 356
                    complianceWarnings: []
                customerWithWarnings:
                  summary: Customer with expiring licence
                  value:
                    customerAccount: "CUST-002"
                    dataAreaId: "nlpd"
                    businessName: "Apotheek Van der Berg"
                    businessCategory: "CommunityPharmacy"
                    country: "NL"
                    approvalStatus: "Approved"
                    isSuspended: false
                    canTransact: true
                    licences:
                      - licenceId: "lic-customer-pharmacy-002"
                        licenceNumber: "APO-2023-111222"
                        licenceType: "Community Pharmacy Licence"
                        status: "Valid"
                        expiryDate: "2026-02-28"
                        daysUntilExpiry: 50
                      - licenceId: "lic-customer-opium-002"
                        licenceNumber: "OA-2025-333444"
                        licenceType: "Opium Act Exemption"
                        status: "Valid"
                        expiryDate: "2028-03-31"
                        daysUntilExpiry: 811
                    complianceWarnings:
                      - severity: "Warning"
                        message: "Pharmacy licence expires in 50 days (2026-02-28). Renewal required."
                        licenceId: "lic-customer-pharmacy-002"
                suspendedCustomer:
                  summary: Suspended customer
                  value:
                    customerAccount: "CUST-003"
                    dataAreaId: "nlpd"
                    businessName: "Veterinary Clinic Amsterdam"
                    businessCategory: "Veterinarian"
                    country: "NL"
                    approvalStatus: "Approved"
                    isSuspended: true
                    suspensionReason: "Multiple suspicious order reports under investigation by IGJ"
                    canTransact: false
                    licences:
                      - licenceId: "lic-customer-vet-001"
                        licenceNumber: "VET-2025-555666"
                        licenceType: "Veterinary Licence"
                        status: "Valid"
                        expiryDate: "2026-08-31"
                        daysUntilExpiry: 234
                    complianceWarnings:
                      - severity: "Critical"
                        message: "Customer suspended. Sales blocked. Reason: Multiple suspicious order reports under investigation by IGJ."
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /warehouse/operations/validate:
    post:
      summary: Warehouse operation validation
      description: |
        Validates whether warehouse operations (pick, pack, print labels) can proceed for controlled drug
        shipments. Warehouse management systems call this endpoint before allowing warehouse staff to perform
        these operations, ensuring warehouse processing aligns with legal controls.

        **FR-023**: API endpoint for warehouse operation validation

        **Performance**: Responds within 3 seconds for 99% of requests
      operationId: validateWarehouseOperation
      tags:
        - Warehouse Operations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WarehouseOperationValidationRequest'
            example:
              externalTransactionId: "SO-2026-0012345"
              operationType: "Pick"
              warehouseSiteId: "site-warehouse-001"
              requestedAt: "2026-01-09T18:30:00Z"
      responses:
        '200':
          description: Warehouse operation validation completed
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
            X-RateLimit-Reset:
              $ref: '#/components/headers/X-RateLimit-Reset'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WarehouseOperationValidationResponse'
              examples:
                allowed:
                  summary: Operation allowed
                  value:
                    allowed: true
                    message: "Operation allowed. All compliance checks passed."
                    transactionId: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
                    complianceStatus: "Passed"
                blocked:
                  summary: Operation blocked
                  value:
                    allowed: false
                    message: "Operation blocked. Transaction pending compliance review."
                    transactionId: "4fb96g75-6828-5673-c4gd-3d074g77bgb7"
                    complianceStatus: "Pending"
                    blockReason: "Awaiting compliance manager approval."
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Transaction not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                errorCode: "TRANSACTION_NOT_FOUND"
                message: "No compliance validation found for transaction SO-2026-0012345. Order may not have been validated yet."
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /products:
    get:
      summary: Browse products with substance classification
      description: |
        Retrieves products from D365 F&O with their resolved substance classification codes.
        Optionally filters to controlled products only. Used by the compliance UI to browse
        D365 products and their controlled substance mappings.

        Products are read-only from D365 F&O `ReleasedProductsV2`. The `substanceCode` is resolved
        from D365 F&O product attributes.
      operationId: listProducts
      tags:
        - Products
      parameters:
        - name: controlled
          in: query
          required: false
          description: If true, only returns products with a controlled substance attribute
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Products retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProductResponse'
              examples:
                productList:
                  summary: Products with substance codes
                  value:
                    - itemNumber: "MOR-10MG-AMP"
                      dataAreaId: "nlpd"
                      productNumber: "MOR-10MG-AMP"
                      productName: "Morphine 10mg Ampule"
                      substanceCode: "MORPHINE"
                      opiumActListValue: "ListI"
                      precursorCategoryValue: null
                      isControlledSubstance: true
                    - itemNumber: "FEN-100MCG-PATCH"
                      dataAreaId: "nlpd"
                      productNumber: "FEN-100MCG-PATCH"
                      productName: "Fentanyl 100mcg Patch"
                      substanceCode: "FENTANYL"
                      opiumActListValue: "ListI"
                      precursorCategoryValue: null
                      isControlledSubstance: true
                    - itemNumber: "PARA-500MG-TAB"
                      dataAreaId: "nlpd"
                      productNumber: "PARA-500MG-TAB"
                      productName: "Paracetamol 500mg Tablet"
                      substanceCode: null
                      opiumActListValue: null
                      precursorCategoryValue: null
                      isControlledSubstance: false
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /products/{itemNumber}:
    get:
      summary: Get product details
      description: |
        Retrieves a single product by item number and data area from D365 F&O, including its
        resolved substance classification attributes.
      operationId: getProduct
      tags:
        - Products
      parameters:
        - name: itemNumber
          in: path
          required: true
          description: D365 F&O item number
          schema:
            type: string
            example: "MOR-10MG-AMP"
        - name: dataAreaId
          in: query
          required: false
          description: D365 F&O data area / legal entity ID
          schema:
            type: string
            example: "nlpd"
      responses:
        '200':
          description: Product details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductResponse'
              examples:
                controlledProduct:
                  summary: A controlled substance product
                  value:
                    itemNumber: "MOR-10MG-AMP"
                    dataAreaId: "nlpd"
                    productNumber: "MOR-10MG-AMP"
                    productName: "Morphine 10mg Ampule"
                    substanceCode: "MORPHINE"
                    opiumActListValue: "ListI"
                    precursorCategoryValue: null
                    isControlledSubstance: true
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    OAuth2:
      type: oauth2
      description: Azure AD OAuth2 authentication
      flows:
        clientCredentials:
          tokenUrl: https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token
          scopes:
            compliance.transactions.validate: Validate transaction compliance
            compliance.transactions.read: Read transaction status
            compliance.transactions.override: Approve compliance overrides
            compliance.customers.read: Read customer compliance status
            compliance.products.read: Read product and substance information

  headers:
    X-RateLimit-Limit:
      description: Maximum requests per hour
      schema:
        type: integer
        example: 1000
    X-RateLimit-Remaining:
      description: Remaining requests in current window
      schema:
        type: integer
        example: 995
    X-RateLimit-Reset:
      description: Unix timestamp when rate limit resets
      schema:
        type: integer
        example: 1704816000

  schemas:
    TransactionValidationRequest:
      type: object
      required:
        - externalId
        - customerAccount
        - customerDataAreaId
        - lines
      properties:
        externalId:
          type: string
          description: External order/shipment number from ERP system
          example: "SO-2026-0012345"
        transactionType:
          type: string
          enum: [Order, Shipment, Return, Transfer]
          description: Type of transaction
          default: "Order"
          example: "Order"
        direction:
          type: string
          enum: [Internal, Inbound, Outbound]
          description: Direction for cross-border (Internal, Inbound, Outbound)
          default: "Internal"
          example: "Internal"
        customerAccount:
          type: string
          description: Customer account code from D365 F&O CustomersV3 entity
          example: "CUST-001"
        customerDataAreaId:
          type: string
          description: D365 F&O data area / legal entity ID
          example: "nlpd"
        originCountry:
          type: string
          description: Origin country (ISO 3166-1 alpha-2)
          default: "NL"
          example: "NL"
        destinationCountry:
          type: string
          description: ISO 3166-1 alpha-2 country code (required for cross-border transactions)
          example: "DE"
          nullable: true
        transactionDate:
          type: string
          format: date-time
          description: Transaction date/time (ISO 8601)
          example: "2026-01-09T14:30:00Z"
        integrationSystemId:
          type: string
          description: Integration system ID that is submitting the transaction (e.g., "D365FO", "WMS", "OrderManagement", "Portal")
          example: "D365FO"
          nullable: true
        externalUserId:
          type: string
          description: User ID in external system who initiated transaction
          example: "erp.user@hospital.nl"
          nullable: true
        warehouseSiteId:
          type: string
          description: Warehouse site ID for warehouse-related transactions
          example: "site-warehouse-001"
          nullable: true
        lines:
          type: array
          description: Transaction lines (products/substances)
          items:
            $ref: '#/components/schemas/TransactionLine'

    TransactionLine:
      type: object
      required:
        - itemNumber
        - dataAreaId
      properties:
        itemNumber:
          type: string
          description: D365 F&O item number identifying the product
          example: "MOR-10MG-AMP"
        dataAreaId:
          type: string
          description: D365 F&O legal entity / data area for the product
          example: "nlpd"
        substanceCode:
          type: string
          description: Substance code (resolved by the system, read-only in responses)
          example: "MORPHINE"
          nullable: true
        substanceName:
          type: string
          description: Substance name (resolved by the system, read-only in responses)
          example: "Morphine"
          nullable: true
        productDescription:
          type: string
          description: Product description
          example: "Morphine 10mg Ampule"
          nullable: true
        batchNumber:
          type: string
          description: Batch/lot number
          example: "BATCH-2026-001"
          nullable: true
        quantity:
          type: number
          format: decimal
          description: Quantity
          example: 100
        unitOfMeasure:
          type: string
          description: Unit of measure (e.g., g, kg, pieces, ampules, tablets)
          example: "ampules"
          nullable: true
        baseUnitQuantity:
          type: number
          format: decimal
          description: Quantity in base unit (for threshold comparison)
          example: 1000
          nullable: true
        baseUnit:
          type: string
          description: Base unit (e.g., "g", "mg")
          example: "g"
          nullable: true
        lineValue:
          type: number
          format: decimal
          description: Line value
          example: 500.00
          nullable: true
        unitPrice:
          type: number
          format: decimal
          description: Unit price
          example: 5.00
          nullable: true

    TransactionValidationResponse:
      type: object
      required:
        - isValid
        - canProceed
        - canOverride
        - status
        - transactionId
        - externalId
        - validationTimeMs
        - violations
        - licenceUsages
      properties:
        isValid:
          type: boolean
          description: Whether the validation passed
          example: true
        canProceed:
          type: boolean
          description: Whether the transaction can proceed (passed or approved with override)
          example: true
        canOverride:
          type: boolean
          description: Whether override is available for this transaction
          example: false
        status:
          type: string
          enum: [Pending, Passed, Failed, ApprovedWithOverride, RejectedOverride]
          description: Validation status
          example: "Passed"
        transactionId:
          type: string
          format: uuid
          description: Internal transaction ID (GUID)
          example: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
        externalId:
          type: string
          description: External ID from request
          example: "SO-2026-0012345"
        validationTimeMs:
          type: integer
          format: int64
          description: Validation time in milliseconds
          example: 245
        violations:
          type: array
          description: Compliance violations (empty if valid)
          items:
            $ref: '#/components/schemas/ComplianceViolation'
        licenceUsages:
          type: array
          description: Licences used to cover the transaction
          items:
            $ref: '#/components/schemas/LicenceUsage'

    ComplianceViolation:
      type: object
      required:
        - errorCode
        - message
        - severity
        - canOverride
      properties:
        errorCode:
          type: string
          description: Standardized error code matching ViolationType enum values (NoLicence, ExpiredLicence, InsufficientScope, ThresholdExceeded, CustomerNotQualified, CrossBorderNoPermit, LicenceSuspended, CustomerSuspended, SubstanceNotFound)
          example: "ExpiredLicence"
        message:
          type: string
          description: Human-readable violation message
          example: "Customer's Opium Act exemption expired on 2025-12-31. Required for morphine (List I)."
        severity:
          type: string
          enum: [Critical, Warning, Info]
          description: Severity level
          example: "Critical"
        canOverride:
          type: boolean
          description: Whether this specific violation can be overridden
          example: false
        lineNumber:
          type: integer
          description: Transaction line number with violation (null for transaction-level violations)
          example: 1
          nullable: true
        substanceCode:
          type: string
          description: Substance code related to this violation
          example: "MORPHINE"
          nullable: true

    LicenceUsage:
      type: object
      required:
        - licenceId
        - licenceNumber
      properties:
        licenceId:
          type: string
          format: uuid
          description: Licence ID (GUID)
          example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        licenceNumber:
          type: string
          description: Official licence number
          example: "OA-2024-789456"
        licenceTypeName:
          type: string
          description: Licence type name
          example: "Opium Act Exemption"
          nullable: true
        coveredLineNumbers:
          type: array
          description: Transaction line numbers covered by this licence
          items:
            type: integer
          example: [1, 2]
        coveredSubstanceCodes:
          type: array
          description: Substance codes covered by this licence
          items:
            type: string
          example: ["MORPHINE", "FENTANYL"]
        coveredQuantity:
          type: number
          format: decimal
          description: Quantity covered by this licence
          example: 100
        coveredQuantityUnit:
          type: string
          description: Unit for covered quantity
          example: "g"

    TransactionResponse:
      type: object
      required:
        - id
        - externalId
        - transactionType
        - direction
        - customerAccount
        - customerDataAreaId
        - originCountry
        - transactionDate
        - totalQuantity
        - status
        - validationStatus
        - requiresOverride
        - overrideStatus
        - lines
        - violations
        - complianceWarnings
        - complianceErrors
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          description: Internal transaction ID (GUID)
          example: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
        externalId:
          type: string
          description: External order/shipment number from ERP system
          example: "SO-2026-0012345"
        transactionType:
          type: string
          enum: [Order, Shipment, Return, Transfer]
          description: Type of transaction
          example: "Order"
        direction:
          type: string
          enum: [Internal, Inbound, Outbound]
          description: Direction for cross-border
          example: "Internal"
        customerAccount:
          type: string
          description: Customer account code
          example: "CUST-001"
        customerDataAreaId:
          type: string
          description: D365 F&O data area / legal entity ID
          example: "nlpd"
        customerName:
          type: string
          description: Customer business name
          example: "Ziekenhuis St. Elisabeth"
          nullable: true
        originCountry:
          type: string
          description: Origin country (ISO 3166-1 alpha-2)
          example: "NL"
        destinationCountry:
          type: string
          description: Destination country (ISO 3166-1 alpha-2)
          example: "DE"
          nullable: true
        transactionDate:
          type: string
          format: date-time
          description: Transaction date/time (ISO 8601)
          example: "2026-01-09T14:30:00Z"
        totalQuantity:
          type: number
          format: decimal
          description: Total quantity across all lines (in base unit)
          example: 1000
        totalValue:
          type: number
          format: decimal
          description: Total value across all lines
          example: 5000.00
          nullable: true
        status:
          type: string
          description: Transaction status
          example: "Pending"
        validationStatus:
          type: string
          enum: [Pending, Passed, Failed, ApprovedWithOverride, RejectedOverride]
          description: Validation status
          example: "Passed"
        validationDate:
          type: string
          format: date-time
          description: When validation was performed (ISO 8601)
          example: "2026-01-09T14:30:02Z"
          nullable: true
        requiresOverride:
          type: boolean
          description: Whether the transaction requires override approval
          example: false
        overrideStatus:
          type: string
          enum: [None, Pending, Approved, Rejected]
          description: Override request status
          example: "None"
        overrideJustification:
          type: string
          description: Justification for override approval
          example: "Emergency medical supply for hospital."
          nullable: true
        overrideRejectionReason:
          type: string
          description: Reason for override rejection
          example: "Customer licence renewal has not been submitted."
          nullable: true
        lines:
          type: array
          description: Transaction line items
          items:
            $ref: '#/components/schemas/TransactionLine'
        violations:
          type: array
          description: Compliance violations
          items:
            $ref: '#/components/schemas/ComplianceViolation'
        complianceWarnings:
          type: array
          description: Compliance warning messages
          items:
            type: string
        complianceErrors:
          type: array
          description: Compliance error messages
          items:
            type: string
        createdAt:
          type: string
          format: date-time
          description: When the transaction was created (ISO 8601)
          example: "2026-01-09T14:30:00Z"

    OverrideApprovalRequest:
      type: object
      required:
        - justification
      properties:
        justification:
          type: string
          description: Justification for approving the override
          example: "Emergency medical supply for hospital COVID unit. Customer's Opium Act exemption renewal application submitted to IGJ on 2025-12-15, currently in progress."

    OverrideRejectionRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          description: Reason for rejecting the override
          example: "Customer licence renewal has not been submitted. Cannot approve without valid documentation."

    CustomerComplianceStatusResponse:
      type: object
      required:
        - customerAccount
        - dataAreaId
        - businessName
        - businessCategory
        - country
        - approvalStatus
        - isSuspended
        - canTransact
        - licences
        - complianceWarnings
      properties:
        customerAccount:
          type: string
          description: Customer account code from D365 F&O
          example: "CUST-001"
        dataAreaId:
          type: string
          description: D365 F&O data area / legal entity ID
          example: "nlpd"
        businessName:
          type: string
          description: Customer business name
          example: "Ziekenhuis St. Elisabeth"
        businessCategory:
          type: string
          enum:
            - HospitalPharmacy
            - CommunityPharmacy
            - Veterinarian
            - Manufacturer
            - WholesalerEU
            - WholesalerNonEU
            - ResearchInstitution
          description: Type of entity
          example: "HospitalPharmacy"
        country:
          type: string
          description: ISO 3166-1 alpha-2 country code
          example: "NL"
        approvalStatus:
          type: string
          enum: [Pending, Approved, ConditionallyApproved, Rejected, Suspended]
          description: Qualification status
          example: "Approved"
        isSuspended:
          type: boolean
          description: Whether sales are blocked
          example: false
        suspensionReason:
          type: string
          description: Reason for suspension
          example: "Multiple suspicious order reports under investigation by IGJ"
          nullable: true
        canTransact:
          type: boolean
          description: Whether transactions are allowed (considers approval status and suspension)
          example: true
        licences:
          type: array
          description: Customer's active licences
          items:
            $ref: '#/components/schemas/CustomerLicenceSummary'
        complianceWarnings:
          type: array
          description: Compliance warnings (expiring licences, suspensions, etc.)
          items:
            $ref: '#/components/schemas/ComplianceWarning'

    CustomerLicenceSummary:
      type: object
      required:
        - licenceId
        - licenceNumber
        - licenceType
        - status
      properties:
        licenceId:
          type: string
          description: Licence ID
          example: "lic-customer-pharmacy-001"
        licenceNumber:
          type: string
          description: Official licence number
          example: "APO-2024-987654"
        licenceType:
          type: string
          description: Licence type name
          example: "Hospital Pharmacy Licence"
        status:
          type: string
          enum: [Valid, Expired, Suspended, Revoked]
          description: Current status
          example: "Valid"
        expiryDate:
          type: string
          format: date
          description: Expiry date (ISO 8601 date)
          example: "2027-06-30"
          nullable: true
        daysUntilExpiry:
          type: integer
          description: Days until expiry (null if no expiry)
          example: 537
          nullable: true

    ComplianceWarning:
      type: object
      required:
        - severity
        - message
      properties:
        severity:
          type: string
          enum: [Critical, Warning, Info]
          description: Warning severity
          example: "Warning"
        message:
          type: string
          description: Warning message
          example: "Pharmacy licence expires in 50 days (2026-02-28). Renewal required."
        licenceId:
          type: string
          description: Related licence ID
          example: "lic-customer-pharmacy-002"
          nullable: true

    WarehouseOperationValidationRequest:
      type: object
      required:
        - externalTransactionId
        - operationType
      properties:
        externalTransactionId:
          type: string
          description: External transaction ID (sales order number, shipment ID)
          example: "SO-2026-0012345"
        operationType:
          type: string
          enum: [Pick, Pack, PrintLabels, ShipmentRelease]
          description: Type of warehouse operation
          example: "Pick"
        warehouseSiteId:
          type: string
          description: Warehouse site ID where operation will occur
          example: "site-warehouse-001"
          nullable: true
        requestedAt:
          type: string
          format: date-time
          description: When operation was requested (ISO 8601)
          example: "2026-01-09T18:30:00Z"
        integrationSystemId:
          type: string
          description: Integration system ID making the validation request (for audit)
          example: "WMS"
          nullable: true

    WarehouseOperationValidationResponse:
      type: object
      required:
        - allowed
        - message
      properties:
        allowed:
          type: boolean
          description: Whether operation is allowed
          example: true
        message:
          type: string
          description: Explanation message
          example: "Operation allowed. All compliance checks passed."
        transactionId:
          type: string
          format: uuid
          description: Internal transaction ID
          example: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
          nullable: true
        complianceStatus:
          type: string
          description: Transaction compliance status (stringified ValidationStatus)
          example: "Passed"
          nullable: true
        blockReason:
          type: string
          description: Reason operation is blocked (if not allowed)
          example: "Awaiting compliance manager approval."
          nullable: true

    ProductResponse:
      type: object
      required:
        - itemNumber
        - dataAreaId
        - productNumber
        - productName
        - isControlledSubstance
      properties:
        itemNumber:
          type: string
          description: D365 F&O item number
          example: "MOR-10MG-AMP"
        dataAreaId:
          type: string
          description: D365 F&O data area / legal entity
          example: "nlpd"
        productNumber:
          type: string
          description: Global product number
          example: "MOR-10MG-AMP"
        productName:
          type: string
          description: Product display name
          example: "Morphine 10mg Ampule"
        productDescription:
          type: string
          description: Product description
          example: "Morphine hydrochloride 10mg/mL solution for injection, 1mL ampule"
          nullable: true
        substanceCode:
          type: string
          description: Resolved substance classification code (null if not a controlled substance)
          example: "MORPHINE"
          nullable: true
        opiumActListValue:
          type: string
          description: Dutch Opium Act classification value
          example: "ListI"
          nullable: true
        precursorCategoryValue:
          type: string
          description: EU precursor regulation category value
          example: null
          nullable: true
        isControlledSubstance:
          type: boolean
          description: Whether this product is a controlled substance
          example: true

    ErrorResponse:
      type: object
      required:
        - errorCode
        - message
      properties:
        errorCode:
          type: string
          description: Standardized error code (e.g., "VALIDATION_ERROR", "TRANSACTION_NOT_FOUND")
          example: "VALIDATION_ERROR"
        message:
          type: string
          description: Human-readable error message describing what went wrong
          example: "Invalid request data"

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            errorCode: "VALIDATION_ERROR"
            message: "Invalid request data"

    Unauthorized:
      description: Authentication required or invalid credentials
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            errorCode: "UNAUTHORIZED"
            message: "Valid OAuth2 token required"

    Forbidden:
      description: Insufficient permissions for requested operation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            errorCode: "FORBIDDEN"
            message: "Insufficient permissions. Required scope: compliance.transactions.override"

    NotFound:
      description: Requested resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            errorCode: "TRANSACTION_NOT_FOUND"
            message: "Transaction not found"

    TooManyRequests:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          $ref: '#/components/headers/X-RateLimit-Limit'
        X-RateLimit-Remaining:
          schema:
            type: integer
            example: 0
        X-RateLimit-Reset:
          $ref: '#/components/headers/X-RateLimit-Reset'
        Retry-After:
          description: Seconds until rate limit resets
          schema:
            type: integer
            example: 3600
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            errorCode: "RATE_LIMIT_EXCEEDED"
            message: "Rate limit exceeded. Maximum 1000 requests per hour."

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            errorCode: "INTERNAL_ERROR"
            message: "An unexpected error occurred. Please contact support."

    ServiceUnavailable:
      description: Service temporarily unavailable
      headers:
        Retry-After:
          description: Seconds until service may be available
          schema:
            type: integer
            example: 300
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            errorCode: "SERVICE_UNAVAILABLE"
            message: "Service temporarily unavailable due to maintenance. Please retry in 5 minutes."
