openapi: 3.0.3
info:
  title: Transaction Validation API
  description: |
    Transaction validation API for external systems (ERP, Order Management, WMS) to validate compliance
    of controlled drug transactions. This API provides real-time compliance checks for orders and warehouse
    operations, ensuring all transactions comply with Dutch Opium Act, Medicines Act, and GDP requirements.

    **Functional Requirements Covered**: FR-018 through FR-024

    **Integration Pattern**: External order management and warehouse systems call these endpoints synchronously
    during order entry and shipment workflows. The API returns pass/fail/pending status that calling systems
    use to block or allow warehouse processing.
  version: 1.0.0
  contact:
    name: Compliance API Support
    email: compliance-api@example.nl

servers:
  - url: https://api.compliance.example.nl/api/v1
    description: Production environment
  - url: https://api-staging.compliance.example.nl/api/v1
    description: Staging environment
  - url: https://api-sandbox.compliance.example.nl/api/v1
    description: Sandbox environment for integration testing

security:
  - OAuth2:
      - compliance.transactions.validate
      - compliance.transactions.read
      - compliance.customers.read

paths:
  /transactions/validate:
    post:
      summary: Validate order compliance
      description: |
        Validates whether a proposed transaction (sales order, transfer, cross-border shipment) complies with
        all applicable licence, permit, and GDP requirements. Returns pass/fail/pending status with detailed
        violation information if non-compliant.

        **FR-018**: Accepts transaction details and returns compliance check results
        **FR-019**: Returns "pending compliance" status for orders lacking required licences
        **FR-020**: Returns structured error messages for each violation
        **FR-021**: Validates import/export permits for cross-border transactions
        **FR-022**: Checks quantity/frequency thresholds for suspicious-order monitoring
        **FR-024**: Validates both customer and company licences

        **Performance**: Responds within 3 seconds for 99% of requests (SC-032, FR-058)
      operationId: validateTransaction
      tags:
        - Transaction Validation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransactionValidationRequest'
            examples:
              domesticOrder:
                summary: Domestic order with controlled substances
                value:
                  externalTransactionId: "SO-2026-0012345"
                  customerAccount: "CUST-001"
                  customerDataAreaId: "nlpd"
                  transactionType: "DomesticSale"
                  transactionDate: "2026-01-09T14:30:00Z"
                  externalUserId: "erp.user@hospital.nl"
                  lines:
                    - substanceId: "sub-001-morphine"
                      internalCode: "MOR-10MG-AMP"
                      quantity: 100
                      unitOfMeasure: "ampules"
                    - substanceId: "sub-002-fentanyl"
                      internalCode: "FEN-100MCG-PATCH"
                      quantity: 50
                      unitOfMeasure: "patches"
              crossBorderExport:
                summary: Cross-border export to Germany
                value:
                  externalTransactionId: "SO-2026-0012346"
                  customerAccount: "CUST-002"
                  customerDataAreaId: "nlpd"
                  transactionType: "EUCrossBorder"
                  transactionDate: "2026-01-09T15:45:00Z"
                  externalUserId: "erp.user@wholesaler.de"
                  destinationCountry: "DE"
                  lines:
                    - substanceId: "sub-003-methylphenidate"
                      internalCode: "MPH-18MG-TAB"
                      quantity: 500
                      unitOfMeasure: "tablets"
      responses:
        '200':
          description: Validation completed successfully (may be pass, pending, or failed)
          headers:
            X-RateLimit-Limit:
              description: Maximum requests per hour
              schema:
                type: integer
                example: 1000
            X-RateLimit-Remaining:
              description: Remaining requests in current window
              schema:
                type: integer
                example: 995
            X-RateLimit-Reset:
              description: Unix timestamp when rate limit resets
              schema:
                type: integer
                example: 1704816000
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionValidationResponse'
              examples:
                passCompliant:
                  summary: Compliant transaction (PASS)
                  value:
                    transactionId: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
                    externalTransactionId: "SO-2026-0012345"
                    complianceStatus: "Pass"
                    message: "Transaction compliant. All required licences valid."
                    validatedAt: "2026-01-09T14:30:02Z"
                    violations: []
                    licencesUsed:
                      - licenceId: "lic-customer-opium-001"
                        licenceNumber: "OA-2024-789456"
                        licenceType: "Opium Act Exemption"
                        holder: "Customer"
                      - licenceId: "lic-company-wda-001"
                        licenceNumber: "WDA-NL-123456"
                        licenceType: "Wholesale Distribution Authorisation"
                        holder: "Company"
                pendingExpiredLicence:
                  summary: Non-compliant - Expired licence (PENDING)
                  value:
                    transactionId: "4fb96g75-6828-5673-c4gd-3d074g77bgb7"
                    externalTransactionId: "SO-2026-0012346"
                    complianceStatus: "Pending"
                    message: "Transaction requires compliance review. Customer licence expired."
                    validatedAt: "2026-01-09T15:45:03Z"
                    violations:
                      - violationType: "LICENCE_EXPIRED"
                        severity: "Critical"
                        lineNumber: 1
                        substanceCode: "MOR-10MG-AMP"
                        description: "Customer's Opium Act exemption expired on 2025-12-31. Required for morphine (List I)."
                        requiredLicenceType: "Opium Act Exemption"
                        missingLicenceNumber: "OA-2023-654321"
                    licencesUsed:
                      - licenceId: "lic-company-wda-001"
                        licenceNumber: "WDA-NL-123456"
                        licenceType: "Wholesale Distribution Authorisation"
                        holder: "Company"
                failedThreshold:
                  summary: Non-compliant - Threshold exceeded (PENDING)
                  value:
                    transactionId: "5gc07h86-7939-6784-d5he-4e185h88chc8"
                    externalTransactionId: "SO-2026-0012347"
                    complianceStatus: "Pending"
                    message: "Transaction flagged for suspicious order monitoring review."
                    validatedAt: "2026-01-09T16:20:05Z"
                    violations:
                      - violationType: "THRESHOLD_EXCEEDED"
                        severity: "Warning"
                        lineNumber: 1
                        substanceCode: "FEN-100MCG-PATCH"
                        description: "Order quantity (500 patches) exceeds monthly threshold (200 patches) for this customer and substance. Review required per Opium Act monitoring obligations."
                        thresholdType: "MonthlyQuantity"
                        thresholdLimit: 200
                        currentPeriodTotal: 350
                        thisOrderQuantity: 500
                    licencesUsed:
                      - licenceId: "lic-customer-opium-002"
                        licenceNumber: "OA-2025-111222"
                        licenceType: "Opium Act Exemption"
                        holder: "Customer"
                failedMissingPermit:
                  summary: Non-compliant - Missing import/export permit (PENDING)
                  value:
                    transactionId: "6hd18i97-8040-7895-e6if-5f296i99did9"
                    externalTransactionId: "SO-2026-0012348"
                    complianceStatus: "Pending"
                    message: "Transaction requires compliance review. Missing import/export permits."
                    validatedAt: "2026-01-09T17:10:07Z"
                    violations:
                      - violationType: "MISSING_PERMIT"
                        severity: "Critical"
                        lineNumber: 1
                        substanceCode: "MPH-18MG-TAB"
                        description: "Export to Germany requires valid export permit from NL authorities for methylphenidate (List I precursor). No export permit found."
                        requiredLicenceType: "Export Permit"
                      - violationType: "MISSING_PERMIT"
                        severity: "Critical"
                        lineNumber: 1
                        substanceCode: "MPH-18MG-TAB"
                        description: "Import certificate from German authorities required. Customer has not provided import certificate."
                        requiredLicenceType: "Import Certificate"
                    licencesUsed: []
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /transactions/{externalId}/status:
    get:
      summary: Check validation status
      description: |
        Retrieves the current compliance status of a transaction by its external transaction ID.
        Useful for polling to check if a pending transaction has been approved or rejected by compliance team.

        **FR-019b**: External systems can check override approval status

        **Performance**: Responds within 1 second for 99% of requests (SC-033)
      operationId: getTransactionStatus
      tags:
        - Transaction Validation
      parameters:
        - name: externalId
          in: path
          required: true
          description: External transaction ID from calling system (e.g., sales order number)
          schema:
            type: string
            example: "SO-2026-0012345"
      responses:
        '200':
          description: Transaction status retrieved successfully
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
            X-RateLimit-Reset:
              $ref: '#/components/headers/X-RateLimit-Reset'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionStatusResponse'
              examples:
                statusPending:
                  summary: Transaction pending compliance review
                  value:
                    transactionId: "4fb96g75-6828-5673-c4gd-3d074g77bgb7"
                    externalTransactionId: "SO-2026-0012346"
                    complianceStatus: "Pending"
                    message: "Awaiting compliance manager review"
                    lastUpdated: "2026-01-09T15:45:03Z"
                statusApproved:
                  summary: Transaction approved via override
                  value:
                    transactionId: "4fb96g75-6828-5673-c4gd-3d074g77bgb7"
                    externalTransactionId: "SO-2026-0012346"
                    complianceStatus: "OverrideApproved"
                    message: "Approved by compliance manager. Emergency medical supply - licence renewal in progress with IGJ."
                    lastUpdated: "2026-01-09T16:20:15Z"
                    approvedBy: "maria.jansen@example.nl"
                    approvedAt: "2026-01-09T16:20:15Z"
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /transactions/{transactionId}/override:
    post:
      summary: Approve override (compliance UI)
      description: |
        Approves a pending transaction via compliance override workflow. Only accessible by authorized
        compliance users (Compliance Manager role or configured authorized roles) via the compliance
        management UI.

        **FR-019a**: Compliance override workflow for pending orders

        **Note**: This endpoint is intended for use by the compliance management UI, not external systems.
        External systems should poll `/transactions/{externalId}/status` to check approval status.
      operationId: approveTransactionOverride
      tags:
        - Transaction Validation
      security:
        - OAuth2:
            - compliance.transactions.override
      parameters:
        - name: transactionId
          in: path
          required: true
          description: Internal transaction ID (GUID)
          schema:
            type: string
            format: uuid
            example: "4fb96g75-6828-5673-c4gd-3d074g77bgb7"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransactionOverrideRequest'
            example:
              approvalDecision: "Approved"
              justification: "Emergency medical supply for hospital COVID unit. Customer's Opium Act exemption renewal application submitted to IGJ on 2025-12-15, currently in progress. Confirmed via IGJ email dated 2025-12-20. Renewal expected within 14 days."
      responses:
        '200':
          description: Override decision recorded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionOverrideResponse'
              example:
                transactionId: "4fb96g75-6828-5673-c4gd-3d074g77bgb7"
                externalTransactionId: "SO-2026-0012346"
                complianceStatus: "OverrideApproved"
                approvedBy: "maria.jansen@example.nl"
                approvedAt: "2026-01-09T16:20:15Z"
                message: "Transaction approved. Warehouse processing can proceed."
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /customers/{customerAccount}/compliance-status:
    get:
      summary: Customer compliance lookup
      description: |
        Retrieves comprehensive compliance status for a customer, including active licences, approval status,
        suspension status, and expiring licences. Used by external order management systems during customer
        selection to display compliance warnings before order entry.

        Customer is identified by composite key: CustomerAccount (path) + DataAreaId (query).
        Master data sourced from D365 F&O CustomersV3; compliance extensions from Dataverse.

        **FR-060**: Customer master data synchronization API

        **Performance**: Responds within 1 second for 99% of requests (SC-033)
      operationId: getCustomerComplianceStatus
      tags:
        - Customer Compliance
      parameters:
        - name: customerAccount
          in: path
          required: true
          description: Customer account code from D365 F&O (e.g., "CUST-001")
          schema:
            type: string
            example: "CUST-001"
        - name: dataAreaId
          in: query
          required: false
          description: D365 F&O data area / legal entity ID (defaults to configured primary)
          schema:
            type: string
            example: "nlpd"
      responses:
        '200':
          description: Customer compliance status retrieved successfully
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
            X-RateLimit-Reset:
              $ref: '#/components/headers/X-RateLimit-Reset'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CustomerComplianceStatusResponse'
              examples:
                compliantCustomer:
                  summary: Fully compliant customer
                  value:
                    customerAccount: "CUST-001"
                    dataAreaId: "nlpd"
                    businessName: "Ziekenhuis St. Elisabeth"
                    businessCategory: "HospitalPharmacy"
                    country: "NL"
                    approvalStatus: "Approved"
                    isSuspended: false
                    canTransact: true
                    licences:
                      - licenceId: "lic-customer-pharmacy-001"
                        licenceNumber: "APO-2024-987654"
                        licenceType: "Hospital Pharmacy Licence"
                        status: "Valid"
                        expiryDate: "2027-06-30"
                        daysUntilExpiry: 537
                      - licenceId: "lic-customer-opium-001"
                        licenceNumber: "OA-2024-789456"
                        licenceType: "Opium Act Exemption"
                        status: "Valid"
                        expiryDate: "2026-12-31"
                        daysUntilExpiry: 356
                    complianceWarnings: []
                customerWithWarnings:
                  summary: Customer with expiring licence
                  value:
                    customerAccount: "CUST-002"
                    dataAreaId: "nlpd"
                    businessName: "Apotheek Van der Berg"
                    businessCategory: "CommunityPharmacy"
                    country: "NL"
                    approvalStatus: "Approved"
                    isSuspended: false
                    canTransact: true
                    licences:
                      - licenceId: "lic-customer-pharmacy-002"
                        licenceNumber: "APO-2023-111222"
                        licenceType: "Community Pharmacy Licence"
                        status: "Valid"
                        expiryDate: "2026-02-28"
                        daysUntilExpiry: 50
                      - licenceId: "lic-customer-opium-002"
                        licenceNumber: "OA-2025-333444"
                        licenceType: "Opium Act Exemption"
                        status: "Valid"
                        expiryDate: "2028-03-31"
                        daysUntilExpiry: 811
                    complianceWarnings:
                      - severity: "Warning"
                        message: "Pharmacy licence expires in 50 days (2026-02-28). Renewal required."
                        licenceId: "lic-customer-pharmacy-002"
                suspendedCustomer:
                  summary: Suspended customer
                  value:
                    customerAccount: "CUST-003"
                    dataAreaId: "nlpd"
                    businessName: "Veterinary Clinic Amsterdam"
                    businessCategory: "Veterinarian"
                    country: "NL"
                    approvalStatus: "Approved"
                    isSuspended: true
                    suspensionReason: "Multiple suspicious order reports under investigation by IGJ"
                    canTransact: false
                    licences:
                      - licenceId: "lic-customer-vet-001"
                        licenceNumber: "VET-2025-555666"
                        licenceType: "Veterinary Licence"
                        status: "Valid"
                        expiryDate: "2026-08-31"
                        daysUntilExpiry: 234
                    complianceWarnings:
                      - severity: "Critical"
                        message: "Customer suspended. Sales blocked. Reason: Multiple suspicious order reports under investigation by IGJ."
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /warehouse/operations/validate:
    post:
      summary: Warehouse operation validation
      description: |
        Validates whether warehouse operations (pick, pack, print labels) can proceed for controlled drug
        shipments. Warehouse management systems call this endpoint before allowing warehouse staff to perform
        these operations, ensuring warehouse processing aligns with legal controls.

        **FR-023**: API endpoint for warehouse operation validation

        **Performance**: Responds within 3 seconds for 99% of requests
      operationId: validateWarehouseOperation
      tags:
        - Warehouse Operations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WarehouseOperationValidationRequest'
            example:
              externalTransactionId: "SO-2026-0012345"
              operationType: "Pick"
              warehouseSiteId: "site-warehouse-001"
              requestedAt: "2026-01-09T18:30:00Z"
      responses:
        '200':
          description: Warehouse operation validation completed
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
            X-RateLimit-Reset:
              $ref: '#/components/headers/X-RateLimit-Reset'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WarehouseOperationValidationResponse'
              examples:
                allowed:
                  summary: Operation allowed
                  value:
                    allowed: true
                    message: "Operation allowed. All compliance checks passed."
                    transactionId: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
                    complianceStatus: "Pass"
                blocked:
                  summary: Operation blocked
                  value:
                    allowed: false
                    message: "Operation blocked. Transaction pending compliance review."
                    transactionId: "4fb96g75-6828-5673-c4gd-3d074g77bgb7"
                    complianceStatus: "Pending"
                    blockReason: "Customer licence expired. Awaiting compliance manager approval."
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Transaction not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: "TRANSACTION_NOT_FOUND"
                  message: "No compliance validation found for transaction SO-2026-0012345. Order may not have been validated yet."
                  timestamp: "2026-01-09T18:30:05Z"
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    OAuth2:
      type: oauth2
      description: Azure AD OAuth2 authentication
      flows:
        clientCredentials:
          tokenUrl: https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token
          scopes:
            compliance.transactions.validate: Validate transaction compliance
            compliance.transactions.read: Read transaction status
            compliance.transactions.override: Approve compliance overrides
            compliance.customers.read: Read customer compliance status

  headers:
    X-RateLimit-Limit:
      description: Maximum requests per hour
      schema:
        type: integer
        example: 1000
    X-RateLimit-Remaining:
      description: Remaining requests in current window
      schema:
        type: integer
        example: 995
    X-RateLimit-Reset:
      description: Unix timestamp when rate limit resets
      schema:
        type: integer
        example: 1704816000

  schemas:
    TransactionValidationRequest:
      type: object
      required:
        - externalTransactionId
        - customerAccount
        - transactionType
        - transactionDate
        - lines
      properties:
        externalTransactionId:
          type: string
          description: Unique transaction ID from calling system (e.g., sales order number)
          example: "SO-2026-0012345"
        customerAccount:
          type: string
          description: Customer account code from D365 F&O CustomersV3 entity
          example: "CUST-001"
        customerDataAreaId:
          type: string
          description: D365 F&O data area / legal entity ID
          example: "nlpd"
        transactionType:
          type: string
          enum: [DomesticSale, EUCrossBorder, NonEUInternational]
          description: Type of transaction
          example: "DomesticSale"
        transactionDate:
          type: string
          format: date-time
          description: Transaction date/time (ISO 8601)
          example: "2026-01-09T14:30:00Z"
        destinationCountry:
          type: string
          description: ISO 3166-1 alpha-2 country code (required for cross-border transactions)
          example: "DE"
          nullable: true
        externalUserId:
          type: string
          description: User ID in external system who initiated transaction
          example: "erp.user@hospital.nl"
          nullable: true
        lines:
          type: array
          description: Transaction lines (products/substances)
          minItems: 1
          items:
            $ref: '#/components/schemas/TransactionLine'

    TransactionLine:
      type: object
      required:
        - substanceId
        - internalCode
        - quantity
        - unitOfMeasure
      properties:
        substanceId:
          type: string
          description: Controlled substance ID
          example: "sub-001-morphine"
        internalCode:
          type: string
          description: Company's internal product/substance code
          example: "MOR-10MG-AMP"
        quantity:
          type: number
          format: decimal
          description: Quantity
          example: 100
        unitOfMeasure:
          type: string
          description: Unit of measure (e.g., g, kg, pieces, ampules, tablets)
          example: "ampules"

    TransactionValidationResponse:
      type: object
      required:
        - transactionId
        - externalTransactionId
        - complianceStatus
        - message
        - validatedAt
        - violations
        - licencesUsed
      properties:
        transactionId:
          type: string
          format: uuid
          description: Internal transaction ID (GUID)
          example: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
        externalTransactionId:
          type: string
          description: External transaction ID from request
          example: "SO-2026-0012345"
        complianceStatus:
          type: string
          enum: [Pass, Pending, Failed, OverrideApproved]
          description: Validation result
          example: "Pass"
        message:
          type: string
          description: Human-readable summary
          example: "Transaction compliant. All required licences valid."
        validatedAt:
          type: string
          format: date-time
          description: When validation was performed (ISO 8601)
          example: "2026-01-09T14:30:02Z"
        violations:
          type: array
          description: Compliance violations (empty if Pass)
          items:
            $ref: '#/components/schemas/ComplianceViolation'
        licencesUsed:
          type: array
          description: Licences that authorized this transaction
          items:
            $ref: '#/components/schemas/LicenceUsage'

    ComplianceViolation:
      type: object
      required:
        - violationType
        - severity
        - description
      properties:
        violationType:
          type: string
          enum:
            - LICENCE_EXPIRED
            - LICENCE_MISSING
            - LICENCE_SUSPENDED
            - SUBSTANCE_NOT_AUTHORIZED
            - THRESHOLD_EXCEEDED
            - MISSING_PERMIT
            - CUSTOMER_SUSPENDED
            - CUSTOMER_NOT_APPROVED
          description: Standardized error code (FR-064)
          example: "LICENCE_EXPIRED"
        severity:
          type: string
          enum: [Critical, Warning, Info]
          description: Severity level
          example: "Critical"
        lineNumber:
          type: integer
          description: Transaction line number with violation (null for transaction-level violations)
          example: 1
          nullable: true
        substanceCode:
          type: string
          description: Internal substance code
          example: "MOR-10MG-AMP"
          nullable: true
        description:
          type: string
          description: Detailed violation message
          example: "Customer's Opium Act exemption expired on 2025-12-31. Required for morphine (List I)."
        requiredLicenceType:
          type: string
          description: Which licence type is missing or invalid
          example: "Opium Act Exemption"
          nullable: true
        missingLicenceNumber:
          type: string
          description: Licence number that is expired or invalid
          example: "OA-2023-654321"
          nullable: true
        thresholdType:
          type: string
          enum: [MonthlyQuantity, AnnualFrequency]
          description: Type of threshold exceeded
          example: "MonthlyQuantity"
          nullable: true
        thresholdLimit:
          type: number
          description: Threshold limit value
          example: 200
          nullable: true
        currentPeriodTotal:
          type: number
          description: Current period cumulative quantity
          example: 350
          nullable: true
        thisOrderQuantity:
          type: number
          description: Quantity in this order
          example: 500
          nullable: true

    LicenceUsage:
      type: object
      required:
        - licenceId
        - licenceNumber
        - licenceType
        - holder
      properties:
        licenceId:
          type: string
          description: Licence ID
          example: "lic-customer-opium-001"
        licenceNumber:
          type: string
          description: Official licence number
          example: "OA-2024-789456"
        licenceType:
          type: string
          description: Licence type name
          example: "Opium Act Exemption"
        holder:
          type: string
          enum: [Customer, Company]
          description: Who holds this licence
          example: "Customer"

    TransactionStatusResponse:
      type: object
      required:
        - transactionId
        - externalTransactionId
        - complianceStatus
        - message
        - lastUpdated
      properties:
        transactionId:
          type: string
          format: uuid
          description: Internal transaction ID (GUID)
          example: "4fb96g75-6828-5673-c4gd-3d074g77bgb7"
        externalTransactionId:
          type: string
          description: External transaction ID
          example: "SO-2026-0012346"
        complianceStatus:
          type: string
          enum: [Pass, Pending, Failed, OverrideApproved]
          description: Current status
          example: "Pending"
        message:
          type: string
          description: Status message
          example: "Awaiting compliance manager review"
        lastUpdated:
          type: string
          format: date-time
          description: Last status update timestamp (ISO 8601)
          example: "2026-01-09T15:45:03Z"
        approvedBy:
          type: string
          description: Email of user who approved override
          example: "maria.jansen@example.nl"
          nullable: true
        approvedAt:
          type: string
          format: date-time
          description: Override approval timestamp (ISO 8601)
          example: "2026-01-09T16:20:15Z"
          nullable: true

    TransactionOverrideRequest:
      type: object
      required:
        - approvalDecision
        - justification
      properties:
        approvalDecision:
          type: string
          enum: [Approved, Rejected]
          description: Override decision
          example: "Approved"
        justification:
          type: string
          description: Documented justification for approval/rejection
          minLength: 20
          example: "Emergency medical supply for hospital COVID unit. Customer's Opium Act exemption renewal application submitted to IGJ on 2025-12-15, currently in progress."

    TransactionOverrideResponse:
      type: object
      required:
        - transactionId
        - externalTransactionId
        - complianceStatus
        - approvedBy
        - approvedAt
        - message
      properties:
        transactionId:
          type: string
          format: uuid
          description: Internal transaction ID (GUID)
          example: "4fb96g75-6828-5673-c4gd-3d074g77bgb7"
        externalTransactionId:
          type: string
          description: External transaction ID
          example: "SO-2026-0012346"
        complianceStatus:
          type: string
          enum: [OverrideApproved, Failed]
          description: Updated status
          example: "OverrideApproved"
        approvedBy:
          type: string
          description: Email of approving user
          example: "maria.jansen@example.nl"
        approvedAt:
          type: string
          format: date-time
          description: Approval timestamp (ISO 8601)
          example: "2026-01-09T16:20:15Z"
        message:
          type: string
          description: Confirmation message
          example: "Transaction approved. Warehouse processing can proceed."

    CustomerComplianceStatusResponse:
      type: object
      required:
        - customerAccount
        - dataAreaId
        - businessName
        - businessCategory
        - country
        - approvalStatus
        - isSuspended
        - canTransact
        - licences
        - complianceWarnings
      properties:
        customerAccount:
          type: string
          description: Customer account code from D365 F&O
          example: "CUST-001"
        dataAreaId:
          type: string
          description: D365 F&O data area / legal entity ID
          example: "nlpd"
        businessName:
          type: string
          description: Customer business name
          example: "Ziekenhuis St. Elisabeth"
        businessCategory:
          type: string
          enum:
            - HospitalPharmacy
            - CommunityPharmacy
            - Veterinarian
            - Manufacturer
            - WholesalerEU
            - WholesalerNonEU
            - ResearchInstitution
          description: Type of entity
          example: "HospitalPharmacy"
        country:
          type: string
          description: ISO 3166-1 alpha-2 country code
          example: "NL"
        approvalStatus:
          type: string
          enum: [Pending, Approved, ConditionallyApproved, Rejected, Suspended]
          description: Qualification status
          example: "Approved"
        isSuspended:
          type: boolean
          description: Whether sales are blocked
          example: false
        suspensionReason:
          type: string
          description: Reason for suspension
          example: "Multiple suspicious order reports under investigation by IGJ"
          nullable: true
        canTransact:
          type: boolean
          description: Whether transactions are allowed (considers approval status and suspension)
          example: true
        licences:
          type: array
          description: Customer's active licences
          items:
            $ref: '#/components/schemas/CustomerLicenceSummary'
        complianceWarnings:
          type: array
          description: Compliance warnings (expiring licences, suspensions, etc.)
          items:
            $ref: '#/components/schemas/ComplianceWarning'

    CustomerLicenceSummary:
      type: object
      required:
        - licenceId
        - licenceNumber
        - licenceType
        - status
      properties:
        licenceId:
          type: string
          description: Licence ID
          example: "lic-customer-pharmacy-001"
        licenceNumber:
          type: string
          description: Official licence number
          example: "APO-2024-987654"
        licenceType:
          type: string
          description: Licence type name
          example: "Hospital Pharmacy Licence"
        status:
          type: string
          enum: [Valid, Expired, Suspended, Revoked]
          description: Current status
          example: "Valid"
        expiryDate:
          type: string
          format: date
          description: Expiry date (ISO 8601 date)
          example: "2027-06-30"
          nullable: true
        daysUntilExpiry:
          type: integer
          description: Days until expiry (null if no expiry)
          example: 537
          nullable: true

    ComplianceWarning:
      type: object
      required:
        - severity
        - message
      properties:
        severity:
          type: string
          enum: [Critical, Warning, Info]
          description: Warning severity
          example: "Warning"
        message:
          type: string
          description: Warning message
          example: "Pharmacy licence expires in 50 days (2026-02-28). Renewal required."
        licenceId:
          type: string
          description: Related licence ID
          example: "lic-customer-pharmacy-002"
          nullable: true

    WarehouseOperationValidationRequest:
      type: object
      required:
        - externalTransactionId
        - operationType
        - requestedAt
      properties:
        externalTransactionId:
          type: string
          description: External transaction ID (sales order number, shipment ID)
          example: "SO-2026-0012345"
        operationType:
          type: string
          enum: [Pick, Pack, PrintLabels, ShipmentRelease]
          description: Type of warehouse operation
          example: "Pick"
        warehouseSiteId:
          type: string
          description: Warehouse site ID where operation will occur
          example: "site-warehouse-001"
          nullable: true
        requestedAt:
          type: string
          format: date-time
          description: When operation was requested (ISO 8601)
          example: "2026-01-09T18:30:00Z"

    WarehouseOperationValidationResponse:
      type: object
      required:
        - allowed
        - message
        - complianceStatus
      properties:
        allowed:
          type: boolean
          description: Whether operation is allowed
          example: true
        message:
          type: string
          description: Explanation message
          example: "Operation allowed. All compliance checks passed."
        transactionId:
          type: string
          format: uuid
          description: Internal transaction ID
          example: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
          nullable: true
        complianceStatus:
          type: string
          enum: [Pass, Pending, Failed, OverrideApproved]
          description: Transaction compliance status
          example: "Pass"
          nullable: true
        blockReason:
          type: string
          description: Reason operation is blocked (if not allowed)
          example: "Customer licence expired. Awaiting compliance manager approval."
          nullable: true

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
            - timestamp
          properties:
            code:
              type: string
              description: Error code
              example: "VALIDATION_ERROR"
            message:
              type: string
              description: Error message
              example: "Invalid request parameters"
            timestamp:
              type: string
              format: date-time
              description: Error timestamp (ISO 8601)
              example: "2026-01-09T14:30:00Z"
            details:
              type: array
              description: Detailed validation errors
              items:
                type: object
                properties:
                  field:
                    type: string
                    example: "customerAccount"
                  message:
                    type: string
                    example: "customerAccount is required"

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "VALIDATION_ERROR"
              message: "Invalid request parameters"
              timestamp: "2026-01-09T14:30:00Z"
              details:
                - field: "customerAccount"
                  message: "customerAccount is required"

    Unauthorized:
      description: Authentication required or invalid credentials
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "UNAUTHORIZED"
              message: "Valid OAuth2 token required"
              timestamp: "2026-01-09T14:30:00Z"

    Forbidden:
      description: Insufficient permissions for requested operation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "FORBIDDEN"
              message: "Insufficient permissions. Required scope: compliance.transactions.override"
              timestamp: "2026-01-09T14:30:00Z"

    NotFound:
      description: Requested resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "NOT_FOUND"
              message: "Transaction not found"
              timestamp: "2026-01-09T14:30:00Z"

    Conflict:
      description: Conflict detected (concurrent modification)
      content:
        application/json:
          schema:
            type: object
            required:
              - error
              - conflictDetails
            properties:
              error:
                type: object
                required:
                  - code
                  - message
                  - timestamp
                properties:
                  code:
                    type: string
                    example: "CONFLICT"
                  message:
                    type: string
                    example: "Resource modified by another user"
                  timestamp:
                    type: string
                    format: date-time
                    example: "2026-01-09T14:30:00Z"
              conflictDetails:
                type: object
                description: Both versions for conflict resolution (FR-027b)
                required:
                  - yourVersion
                  - currentVersion
                properties:
                  yourVersion:
                    type: object
                    description: Your submitted changes
                  currentVersion:
                    type: object
                    description: Current version in system
                  lastModifiedBy:
                    type: string
                    description: User who made conflicting change
                    example: "other.user@example.nl"
                  lastModifiedAt:
                    type: string
                    format: date-time
                    description: When conflicting change was made
                    example: "2026-01-09T14:25:00Z"

    TooManyRequests:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          $ref: '#/components/headers/X-RateLimit-Limit'
        X-RateLimit-Remaining:
          schema:
            type: integer
            example: 0
        X-RateLimit-Reset:
          $ref: '#/components/headers/X-RateLimit-Reset'
        Retry-After:
          description: Seconds until rate limit resets
          schema:
            type: integer
            example: 3600
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "RATE_LIMIT_EXCEEDED"
              message: "Rate limit exceeded. Maximum 1000 requests per hour."
              timestamp: "2026-01-09T14:30:00Z"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "INTERNAL_ERROR"
              message: "An unexpected error occurred. Please contact support."
              timestamp: "2026-01-09T14:30:00Z"

    ServiceUnavailable:
      description: Service temporarily unavailable
      headers:
        Retry-After:
          description: Seconds until service may be available
          schema:
            type: integer
            example: 300
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "SERVICE_UNAVAILABLE"
              message: "Service temporarily unavailable due to maintenance. Please retry in 5 minutes."
              timestamp: "2026-01-09T14:30:00Z"
