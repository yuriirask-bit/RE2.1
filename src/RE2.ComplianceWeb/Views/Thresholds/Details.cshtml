@model RE2.ComplianceCore.Models.Threshold
@using static RE2.Shared.Constants.TransactionTypes
@{
    ViewData["Title"] = $"Threshold: {Model.Name}";

    var typeClass = Model.ThresholdType switch
    {
        ThresholdType.Quantity => "bg-primary",
        ThresholdType.CumulativeQuantity => "bg-info",
        ThresholdType.Frequency => "bg-warning text-dark",
        ThresholdType.Value => "bg-success",
        _ => "bg-secondary"
    };
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-sliders"></i> @Model.Name
            @if (Model.IsActive)
            {
                if (Model.IsEffective())
                {
                    <span class="badge bg-success fs-6">Active</span>
                }
                else
                {
                    <span class="badge bg-warning text-dark fs-6">Scheduled</span>
                }
            }
            else
            {
                <span class="badge bg-secondary fs-6">Inactive</span>
            }
        </h1>
        <div>
            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Main Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Threshold Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Type</dt>
                        <dd class="col-sm-8"><span class="badge @typeClass">@Model.ThresholdType</span></dd>

                        <dt class="col-sm-4">Period</dt>
                        <dd class="col-sm-8">@Model.Period</dd>

                        <dt class="col-sm-4">Description</dt>
                        <dd class="col-sm-8">@(Model.Description ?? "-")</dd>

                        @if (!string.IsNullOrEmpty(Model.RegulatoryReference))
                        {
                            <dt class="col-sm-4">Regulatory Reference</dt>
                            <dd class="col-sm-8">@Model.RegulatoryReference</dd>
                        }
                    </dl>
                </div>
            </div>

            <!-- Limit Configuration -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Limit Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 text-center border-end">
                            <h2 class="text-primary mb-0">@Model.LimitValue.ToString("N2")</h2>
                            <p class="text-muted">@Model.LimitUnit</p>
                            <small>Maximum Limit</small>
                        </div>
                        <div class="col-md-4 text-center border-end">
                            <h2 class="text-warning mb-0">@Model.WarningThresholdPercent%</h2>
                            <p class="text-muted">@((Model.LimitValue * Model.WarningThresholdPercent / 100).ToString("N2")) @Model.LimitUnit</p>
                            <small>Warning Threshold</small>
                        </div>
                        <div class="col-md-4 text-center">
                            @if (Model.AllowOverride && Model.MaxOverridePercent.HasValue)
                            {
                                <h2 class="text-danger mb-0">@Model.MaxOverridePercent.Value%</h2>
                                <p class="text-muted">@((Model.LimitValue * Model.MaxOverridePercent.Value / 100).ToString("N2")) @Model.LimitUnit</p>
                                <small>Max Override</small>
                            }
                            else if (Model.AllowOverride)
                            {
                                <h2 class="text-success mb-0"><i class="bi bi-check-circle"></i></h2>
                                <p class="text-muted">No limit</p>
                                <small>Override Allowed</small>
                            }
                            else
                            {
                                <h2 class="text-secondary mb-0"><i class="bi bi-x-circle"></i></h2>
                                <p class="text-muted">Not allowed</p>
                                <small>No Override</small>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scope -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Scope</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Substance</dt>
                        <dd class="col-sm-8">
                            @if (!string.IsNullOrEmpty(Model.SubstanceName))
                            {
                                <span>@Model.SubstanceName</span>
                                @if (!string.IsNullOrEmpty(Model.SubstanceCode))
                                {
                                    <code class="ms-2">@Model.SubstanceCode</code>
                                }
                            }
                            else
                            {
                                <span class="text-muted">All substances</span>
                            }
                        </dd>

                        <dt class="col-sm-4">Licence Type</dt>
                        <dd class="col-sm-8">
                            @if (!string.IsNullOrEmpty(Model.LicenceTypeName))
                            {
                                <span>@Model.LicenceTypeName</span>
                            }
                            else
                            {
                                <span class="text-muted">All licence types</span>
                            }
                        </dd>

                        <dt class="col-sm-4">Customer Category</dt>
                        <dd class="col-sm-8">
                            @if (Model.CustomerCategory.HasValue)
                            {
                                <span class="badge bg-light text-dark">@Model.CustomerCategory</span>
                            }
                            else
                            {
                                <span class="text-muted">All categories</span>
                            }
                        </dd>

                        <dt class="col-sm-4">Opium Act List</dt>
                        <dd class="col-sm-8">
                            @if (!string.IsNullOrEmpty(Model.OpiumActList))
                            {
                                <span class="badge bg-light text-dark">@Model.OpiumActList</span>
                            }
                            else
                            {
                                <span class="text-muted">All lists</span>
                            }
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Status</h5>
                </div>
                <div class="card-body">
                    <dl class="mb-0">
                        <dt>Active</dt>
                        <dd>
                            @if (Model.IsActive)
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        </dd>

                        <dt>Effective From</dt>
                        <dd>@(Model.EffectiveFrom?.ToString("yyyy-MM-dd") ?? "Immediately")</dd>

                        <dt>Effective To</dt>
                        <dd>@(Model.EffectiveTo?.ToString("yyyy-MM-dd") ?? "No end date")</dd>

                        <dt>Currently Effective</dt>
                        <dd>
                            @if (Model.IsEffective())
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark">No</span>
                            }
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- Audit Info -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Audit Information</h5>
                </div>
                <div class="card-body">
                    <dl class="mb-0">
                        <dt>Created</dt>
                        <dd>@Model.CreatedDate.ToString("yyyy-MM-dd HH:mm")</dd>

                        @if (!string.IsNullOrEmpty(Model.CreatedBy))
                        {
                            <dt>Created By</dt>
                            <dd>@Model.CreatedBy</dd>
                        }

                        @if (Model.ModifiedDate.HasValue)
                        {
                            <dt>Last Modified</dt>
                            <dd>@Model.ModifiedDate.Value.ToString("yyyy-MM-dd HH:mm")</dd>
                        }

                        @if (!string.IsNullOrEmpty(Model.ModifiedBy))
                        {
                            <dt>Modified By</dt>
                            <dd>@Model.ModifiedBy</dd>
                        }
                    </dl>
                </div>
            </div>

            <!-- Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-primary">
                            <i class="bi bi-pencil"></i> Edit Threshold
                        </a>
                        <form asp-action="ToggleActive" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id" />
                            @if (Model.IsActive)
                            {
                                <button type="submit" class="btn btn-outline-warning w-100"
                                        onclick="return confirm('Are you sure you want to deactivate this threshold?');">
                                    <i class="bi bi-pause-circle"></i> Deactivate
                                </button>
                            }
                            else
                            {
                                <button type="submit" class="btn btn-outline-success w-100">
                                    <i class="bi bi-play-circle"></i> Activate
                                </button>
                            }
                        </form>
                        <form asp-action="Delete" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-outline-danger w-100"
                                    onclick="return confirm('Are you sure you want to delete this threshold? This action cannot be undone.');">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
