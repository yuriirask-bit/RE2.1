@model IEnumerable<RE2.ComplianceCore.Models.Licence>
@{
    ViewData["Title"] = "Expiring Licences";
}

<div class="container">
    <h1><i class="bi bi-exclamation-triangle text-warning"></i> Expiring Licences</h1>
    <p>Licences expiring within @ViewBag.DaysAhead days - per FR-007: Generate alerts for expiring licences.</p>

    <div class="mb-3">
        <form method="get" class="d-inline-flex gap-2">
            <label for="daysAhead" class="form-label me-2 my-auto">Show licences expiring within:</label>
            <select name="daysAhead" id="daysAhead" class="form-select" style="width:auto;" onchange="this.form.submit()">
                <option value="30" selected="@(ViewBag.DaysAhead == 30)">30 days</option>
                <option value="60" selected="@(ViewBag.DaysAhead == 60)">60 days</option>
                <option value="90" selected="@(ViewBag.DaysAhead == 90)">90 days</option>
                <option value="180" selected="@(ViewBag.DaysAhead == 180)">180 days</option>
            </select>
        </form>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-success">
            <i class="bi bi-check-circle"></i> No licences expiring within @ViewBag.DaysAhead days.
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-circle"></i> <strong>@Model.Count()</strong> licence(s) expiring soon!
        </div>

        <table class="table table-striped table-hover">
            <thead class="table-warning">
                <tr>
                    <th>Licence Number</th>
                    <th>Licence Type</th>
                    <th>Holder Type</th>
                    <th>Issuing Authority</th>
                    <th>Expiry Date</th>
                    <th>Days Until Expiry</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var licence in Model.OrderBy(l => l.ExpiryDate))
                {
                    var daysUntilExpiry = licence.ExpiryDate.HasValue
                        ? (licence.ExpiryDate.Value.ToDateTime(TimeOnly.MinValue) - DateTime.Today).Days
                        : 0;
                    var urgencyClass = daysUntilExpiry <= 14 ? "table-danger" : daysUntilExpiry <= 30 ? "table-warning" : "";

                    <tr class="@urgencyClass">
                        <td>@licence.LicenceNumber</td>
                        <td>@(licence.LicenceType?.Name ?? "Unknown")</td>
                        <td>@licence.HolderType</td>
                        <td>@licence.IssuingAuthority</td>
                        <td>@licence.ExpiryDate?.ToString("yyyy-MM-dd")</td>
                        <td>
                            @if (daysUntilExpiry <= 14)
                            {
                                <span class="badge bg-danger">@daysUntilExpiry days</span>
                            }
                            else if (daysUntilExpiry <= 30)
                            {
                                <span class="badge bg-warning text-dark">@daysUntilExpiry days</span>
                            }
                            else
                            {
                                <span class="badge bg-info">@daysUntilExpiry days</span>
                            }
                        </td>
                        <td>
                            <a asp-action="Details" asp-route-id="@licence.LicenceId" class="btn btn-sm btn-outline-primary">
                                View
                            </a>
                            <a asp-action="Edit" asp-route-id="@licence.LicenceId" class="btn btn-sm btn-outline-secondary">
                                Renew
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <a asp-action="Index" class="btn btn-secondary">Back to All Licences</a>
</div>
