@model IEnumerable<RE2.ComplianceWeb.Controllers.CredentialIndexItem>
@{
    ViewData["Title"] = "Expiring Credentials";
    var daysAhead = (int)(ViewBag.DaysAhead ?? 90);
    var expiredCount = (int)(ViewBag.ExpiredCount ?? 0);
    var today = DateOnly.FromDateTime(DateTime.UtcNow);
}

<div class="container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-action="Index">GDP Credentials</a></li>
            <li class="breadcrumb-item active">Expiring</li>
        </ol>
    </nav>

    <h1><i class="bi bi-clock-history"></i> Expiring Credentials Dashboard</h1>
    <p>Credentials expiring within @daysAhead days per FR-043</p>

    @if (expiredCount > 0)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>@expiredCount credential(s) have already expired!</strong> Immediate action is required.
        </div>
    }

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card @(expiredCount > 0 ? "border-danger" : "")">
                <div class="card-body text-center">
                    <h2 class="@(expiredCount > 0 ? "text-danger" : "text-muted")">@expiredCount</h2>
                    <p class="mb-0"><i class="bi bi-x-circle"></i> Expired</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h2 class="text-warning">@(Model.Count() - expiredCount)</h2>
                    <p class="mb-0"><i class="bi bi-exclamation-triangle"></i> Expiring Soon</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h2 class="text-primary">@Model.Count()</h2>
                    <p class="mb-0"><i class="bi bi-list-check"></i> Total</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-3">
        <div class="col-auto">
            <form method="get" class="d-flex align-items-center gap-2">
                <label for="days" class="form-label mb-0">Days ahead:</label>
                <select name="days" id="days" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
                    <option value="30" selected="@(daysAhead == 30)">30 days</option>
                    <option value="60" selected="@(daysAhead == 60)">60 days</option>
                    <option value="90" selected="@(daysAhead == 90)">90 days</option>
                    <option value="180" selected="@(daysAhead == 180)">180 days</option>
                    <option value="365" selected="@(daysAhead == 365)">365 days</option>
                </select>
            </form>
        </div>
    </div>

    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Entity Type</th>
                <th>Entity Name</th>
                <th>WDA / Certificate Number</th>
                <th>Valid To</th>
                <th>Days Remaining</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (!Model.Any())
            {
                <tr>
                    <td colspan="7" class="text-center">
                        <em>No credentials expiring within @daysAhead days.</em>
                    </td>
                </tr>
            }
            else
            {
                @foreach (var item in Model)
                {
                    var cred = item.Credential;
                    var isExpired = cred.ValidityEndDate.HasValue && cred.ValidityEndDate.Value < today;
                    var daysRemaining = cred.ValidityEndDate.HasValue
                        ? cred.ValidityEndDate.Value.DayNumber - today.DayNumber
                        : (int?)null;

                    <tr class="@(isExpired ? "table-danger" : daysRemaining <= 30 ? "table-warning" : "")">
                        <td>@item.EntityTypeName</td>
                        <td>@item.EntityName</td>
                        <td><code>@(cred.GdpCertificateNumber ?? cred.WdaNumber ?? "-")</code></td>
                        <td>@(cred.ValidityEndDate?.ToString("yyyy-MM-dd") ?? "-")</td>
                        <td>
                            @if (isExpired)
                            {
                                <span class="text-danger fw-bold">@daysRemaining days (expired)</span>
                            }
                            else if (daysRemaining.HasValue)
                            {
                                <span class="@(daysRemaining <= 30 ? "text-warning fw-bold" : "")">@daysRemaining days</span>
                            }
                        </td>
                        <td>
                            @if (isExpired)
                            {
                                <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Expired</span>
                            }
                            else if (daysRemaining <= 30)
                            {
                                <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle"></i> Critical</span>
                            }
                            else
                            {
                                <span class="badge bg-info"><i class="bi bi-clock"></i> Expiring</span>
                            }
                        </td>
                        <td>
                            <a asp-action="Details" asp-route-id="@cred.CredentialId"
                               class="btn btn-sm btn-outline-primary" title="View Details">
                                <i class="bi bi-eye"></i> View
                            </a>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>

    <div class="text-muted">
        Showing @Model.Count() credential(s) expiring within @daysAhead days
    </div>

    <div class="mt-3">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Credentials
        </a>
    </div>
</div>
