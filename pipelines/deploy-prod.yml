# RE2 Compliance Platform — Deploy to Prod
# Manually triggered. Uses staging slot swap for zero-downtime deployment.
#
# Prerequisites:
#   Service Connection: RE2-Prod-ServiceConnection
#   Variable Group:     re2-prod-secrets (AzureAdTenantId, AzureAdClientId)
#   Environment:        re2-prod (2 approver gate)

trigger: none

resources:
  pipelines:
  - pipeline: build
    source: 'RE2-Build'

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: re2-prod-secrets

stages:
- stage: DeployProd
  displayName: 'Deploy to Prod'
  jobs:
  - deployment: DeployInfra
    displayName: 'Deploy infrastructure'
    environment: 're2-prod'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureCLI@2
            displayName: 'Create resource group'
            inputs:
              azureSubscription: 'RE2-Prod-ServiceConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az group create \
                  --name rg-re2-prod \
                  --location westeurope \
                  --tags environment=prod application=re2-compliance

          - task: AzureCLI@2
            displayName: 'Deploy Bicep templates'
            inputs:
              azureSubscription: 'RE2-Prod-ServiceConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az deployment group create \
                  --resource-group rg-re2-prod \
                  --template-file $(Pipeline.Workspace)/build/drop/infra/main.bicep \
                  --parameters $(Pipeline.Workspace)/build/drop/infra/prod.bicepparam \
                  --parameters azureAdTenantId=$(AzureAdTenantId) \
                               azureAdClientId=$(AzureAdClientId) \
                  --verbose

  - deployment: DeployApps
    displayName: 'Deploy applications (slot swap)'
    dependsOn: DeployInfra
    environment: 're2-prod'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebApp@1
            displayName: 'Deploy API to staging slot'
            inputs:
              azureSubscription: 'RE2-Prod-ServiceConnection'
              appType: 'webApp'
              appName: 'app-re2-api-prod'
              deployToSlotOrASE: true
              slotName: 'staging'
              package: '$(Pipeline.Workspace)/build/drop/api/**/*.zip'

          - task: AzureWebApp@1
            displayName: 'Deploy Web to staging slot'
            inputs:
              azureSubscription: 'RE2-Prod-ServiceConnection'
              appType: 'webApp'
              appName: 'app-re2-web-prod'
              deployToSlotOrASE: true
              slotName: 'staging'
              package: '$(Pipeline.Workspace)/build/drop/web/**/*.zip'

          - task: AzureFunctionApp@2
            displayName: 'Deploy Functions'
            inputs:
              azureSubscription: 'RE2-Prod-ServiceConnection'
              appType: 'functionApp'
              appName: 'func-re2-compliance-prod'
              package: '$(Pipeline.Workspace)/build/drop/functions/**/*.zip'

          - task: AzureCLI@2
            displayName: 'Smoke test — API staging slot'
            inputs:
              azureSubscription: 'RE2-Prod-ServiceConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                API_URL="https://app-re2-api-prod-staging.azurewebsites.net/health"
                echo "Testing $API_URL"
                for i in {1..6}; do
                  STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL" --max-time 10)
                  if [ "$STATUS" = "200" ]; then
                    echo "Staging health check passed (HTTP 200)"
                    exit 0
                  fi
                  echo "Attempt $i: HTTP $STATUS — retrying in 10s..."
                  sleep 10
                done
                echo "Staging health check FAILED"
                exit 1

          - task: AzureCLI@2
            displayName: 'Smoke test — Web staging slot'
            inputs:
              azureSubscription: 'RE2-Prod-ServiceConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                WEB_URL="https://app-re2-web-prod-staging.azurewebsites.net/health"
                echo "Testing $WEB_URL"
                for i in {1..6}; do
                  STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$WEB_URL" --max-time 10)
                  if [ "$STATUS" = "200" ]; then
                    echo "Staging health check passed (HTTP 200)"
                    exit 0
                  fi
                  echo "Attempt $i: HTTP $STATUS — retrying in 10s..."
                  sleep 10
                done
                echo "Staging health check FAILED"
                exit 1

          - task: AzureAppServiceManage@0
            displayName: 'Swap API: staging → production'
            inputs:
              azureSubscription: 'RE2-Prod-ServiceConnection'
              action: 'Swap Slots'
              webAppName: 'app-re2-api-prod'
              resourceGroupName: 'rg-re2-prod'
              sourceSlot: 'staging'

          - task: AzureAppServiceManage@0
            displayName: 'Swap Web: staging → production'
            inputs:
              azureSubscription: 'RE2-Prod-ServiceConnection'
              action: 'Swap Slots'
              webAppName: 'app-re2-web-prod'
              resourceGroupName: 'rg-re2-prod'
              sourceSlot: 'staging'

          # Post-deployment verification
          - task: AzureCLI@2
            displayName: 'Post-swap — verify production health'
            inputs:
              azureSubscription: 'RE2-Prod-ServiceConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "=== Verifying production endpoints ==="
                for APP in "app-re2-api-prod" "app-re2-web-prod"; do
                  URL="https://${APP}.azurewebsites.net/health"
                  echo "Testing $URL"
                  STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" --max-time 10)
                  if [ "$STATUS" != "200" ]; then
                    echo "WARNING: $URL returned HTTP $STATUS after swap"
                  else
                    echo "OK: $URL returned HTTP 200"
                  fi
                done
